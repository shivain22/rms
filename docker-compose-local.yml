version: '3.8'

services:
  postgresql:
    image: postgres:17
    container_name: rms-postgres
    environment:
      # Superuser (postgres) - used for creating tenant databases
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_ADMIN_PASSWORD:-postgres123}
      # Default database for gateway
      POSTGRES_DB: ${DB_NAME:-rms_gateway}
      # Additional settings
      POSTGRES_INITDB_ARGS: '--encoding=UTF8'
    ports:
      - '${DB_PORT:-5432}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./src/main/docker/init-scripts:/docker-entrypoint-initdb.d
    networks:
      - rms-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:23.0.1
    container_name: rms-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgresql:5432/keycloak
      KC_DB_USERNAME: ${DB_USERNAME:-rms}
      KC_DB_PASSWORD: ${DB_PASSWORD:-}
    ports:
      - '9080:8080'
    depends_on:
      - postgresql
    command: start-dev
    networks:
      - rms-network

  rms-app:
    build: .
    container_name: rms-gateway
    environment:
      # Gateway database connection (uses postgres superuser initially)
      - DB_HOST=postgresql
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-rms_gateway}
      - DB_USERNAME=postgres
      - DB_PASSWORD=${POSTGRES_ADMIN_PASSWORD:-postgres123}
      # Platform database admin credentials (for creating tenant databases)
      - PLATFORM_DB_ADMIN_HOST=postgresql
      - PLATFORM_DB_ADMIN_PORT=5432
      - PLATFORM_DB_ADMIN_USER=postgres
      - PLATFORM_DB_ADMIN_PASSWORD=${POSTGRES_ADMIN_PASSWORD:-postgres123}
      - PLATFORM_DB_ADMIN_DATABASE=postgres
      - PLATFORM_DB_INITIALIZE_ON_STARTUP=true
      - PLATFORM_DB_CREATE_DEMO_DATA=true
      # Keycloak configuration
      - KEYCLOAK_HOST=${KEYCLOAK_HOST:-rmsauth.atparui.com}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM:-gateway}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-gateway-web}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET:-M5nP8qR2sT6uV9wX1yZ3aC4dE7fG0h}
      # Other services
      - CONSUL_HOST=consul
      - ELASTICSEARCH_HOST=elasticsearch
      - SPRING_PROFILES_ACTIVE=prod
      - DATABASE_DRIVER_STORAGE_PATH=/shared-drivers
    ports:
      - '${APP_PORT:-8080}:8080'
    volumes:
      - shared-drivers:/shared-drivers
    depends_on:
      - postgresql
      - consul
      - elasticsearch
    networks:
      - rms-network

  consul:
    image: consul:1.15
    container_name: rms-consul
    ports:
      - '${CONSUL_PORT:-8500}:8500'
    networks:
      - rms-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: rms-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - '${ELASTICSEARCH_PORT:-9200}:9200'
    networks:
      - rms-network

volumes:
  postgres_data:
  shared-drivers:
    driver: local
    driver_opts:
      type: none
      o: bind
      # For Windows, use forward slashes or escaped backslashes
      # For Linux/Mac, use absolute path like /path/to/shared-drivers
      device: ${SHARED_DRIVERS_PATH:-C:/Users/shiva/eclipse-workspace/shared-drivers}

networks:
  rms-network:
    driver: bridge
